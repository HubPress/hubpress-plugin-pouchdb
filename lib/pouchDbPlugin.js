"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function pouchDbPlugin(e){e.on("hubpress:request-local-synchronization",function(e){console.info("pouchDbPlugin - hubpress:request-local-synchronization"),console.log("pouchDbPlugin - hubpress:request-local-synchronization",e);var t=e.nextState.posts||[],n=t.map(function(e){return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=_q2.default.defer();return delete e._links,db.find({selector:{type:{$eq:TYPE_POST},"original.name":{$eq:e.name}},limit:1}).then(function(o){if(console.log("POST find values",o),o.docs.length){console.log("pouchDbPlugin - post found",e.name);var u=o.docs[0];u.original&&u.original.content!==e.content||u.published!==e.published?(console.log("pouchDbPlugin - post have changed",e.name),e._id=u._id,e._rev=u._rev,e.type=TYPE_POST,db.put(e).then(function(){e._rev=u._rev,t.push(e),n.resolve(t)}).catch(function(e){n.reject(e)})):(console.log("pouchDbPlugin - post have not changed",e.name),e._id=u._id,e._rev=u._rev,e.type=TYPE_POST,t.push(e),n.resolve(t))}else console.log("pouchDbPlugin - post not found",e.name),e._id=_nodeUuid2.default.v4(),e.type=TYPE_POST,db.put(e).then(function(o){e._rev=o.rev,t.push(e),n.resolve(t)}).catch(function(e){n.reject(e)})}),n.promise}}),o=(n||[]).reduce(function(e,t){return e.then(t)},(0,_q2.default)([])),u=t.map(function(e){return e.name}),i=db.find({selector:{type:{$eq:TYPE_POST},"original.name":{$nin:u}}}).then(function(e){if(e.docs.length){var t=e.docs.map(function(e){return _lodash2.default.pick(e,["_id","_rev","attributes","content","excerpt","html","name","path","title","type","url"])});return db.bulkDocs(t)}return[]});return i.then(function(){return o}).then(function(t){return e.nextState.posts=t,e})}),e.on("application:receive-config",function(e){return console.info("pouchDbPlugin - application:receive-config"),console.log("pouchDbPlugin - application:receive-config",e),db?e:(db=new _pouchdb2.default("hubpress-"+e.nextState.config.meta.username+"-"+e.nextState.config.meta.repositoryName),db.info().then(function(e){console.log("PouchDB infos",e)}),db.createIndex({index:{fields:["name","type"]}}).then(function(){return db.createIndex({index:{fields:["type"]}})}).then(function(){return db.createIndex({index:{fields:["original.name","type"]}})}).then(function(){return db.createIndex({index:{fields:["published","type"]}})}).then(function(){return db.createIndex({index:{fields:["original.name","published","type"]}})}).then(function(){return e}))}),e.on("hubpress:request-local-posts",function(e){return console.info("pouchDbPlugin - hubpress:request-local-posts"),console.log("pouchDbPlugin - hubpress:request-local-posts",e),db.find({selector:{name:{$gt:null},type:{$eq:TYPE_POST}},sort:[{name:"desc"}]}).then(function(t){return e.nextState=Object.assign({},e.nextState,{posts:t.docs}),e})}),e.on("requestSelectedPost",function(e){return console.info("pouchDbPlugin - requestSelectedPost"),console.log("pouchDbPlugin - requestSelectedPost",e),db.get(e.data.post._id).then(function(t){var n=Object.assign({},e.data,{selectedPost:t});return Object.assign({},e,{data:n})})}),e.on("hubpress:request-local-post",function(e){console.info("pouchDbPlugin - hubpress:request-local-post"),console.log("pouchDbPlugin - hubpress:request-local-post",e);var t=_q2.default.defer();return db.get(e.nextState.post._id).then(function(n){e.nextState=Object.assign({},e.nextState,{post:n}),t.resolve(e)}).catch(function(n){404===n.status?(e.nextState=Object.assign({},e.nextState,{post:{_id:e.nextState.post._id}}),t.resolve(e)):t.reject(n)}),t.promise}),e.on("requestSaveLocalPost",function(e){console.info("pouchDbPlugin - requestSaveLocalPost"),console.log("pouchDbPlugin - requestSaveLocalPost",e);var t=_q2.default.defer();return db.find({selector:{_id:{$ne:e.nextState.post._id},name:{$eq:e.nextState.post.name},type:{$eq:TYPE_POST}},limit:1}).then(function(t){if(t.docs.length)throw new Error("Post with the name "+e.nextState.post.name+" already exist");return e.nextState.post._id}).then(function(e){return db.get(e)}).then(function(n){var o=Object.assign({},n,e.nextState.post);o._rev=n._rev,o.type=TYPE_POST,db.put(o).then(function(n){o._rev=n.rev,e.nextState.post=o,t.resolve(e)}).catch(function(e){return t.reject(e)})}).catch(function(n){if(404===n.status){var o=e.nextState.post;db.put(o).then(function(n){o._rev=n.rev,e.nextState.post=o,t.resolve(e)}).catch(function(e){return t.reject(e)})}else t.reject(n)}),t.promise}),e.on("requestLocalPublishedPosts",function(e){return console.info("pouchDbPlugin - requestLocalPublishedPosts"),console.log("pouchDbPlugin - requestLocalPublishedPosts",e),db.find({selector:{"original.name":{$gt:null},published:{$eq:1},type:{$eq:TYPE_POST}},sort:[{"original.name":"desc"}]}).then(function(t){return console.log("requestLocalPublishedPosts => ",t),e.nextState.publishedPosts=t.docs,e})}),e.on("requestDeleteLocalPost",function(e){return console.info("pouchDbPlugin - requestDeleteLocalPost"),console.log("pouchDbPlugin - requestDeleteLocalPost",e),db.remove(e.nextState.post._id,e.nextState.post._rev).then(function(){return e})})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.pouchDbPlugin=pouchDbPlugin;var _q=require("q"),_q2=_interopRequireDefault(_q),_lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash),_nodeUuid=require("node-uuid"),_nodeUuid2=_interopRequireDefault(_nodeUuid),_pouchdb=require("pouchdb"),_pouchdb2=_interopRequireDefault(_pouchdb),_pouchdbFind=require("pouchdb-find"),_pouchdbFind2=_interopRequireDefault(_pouchdbFind);_pouchdb2.default.plugin(_pouchdbFind2.default),window.PouchDB=_pouchdb2.default;var TYPE_POST="post",db=void 0;