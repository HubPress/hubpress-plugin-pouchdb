"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function pouchDbPlugin(e){e.on("requestLocalSynchronization",function(e){console.info("PouchDb Plugin - requestLocalSynchronization"),console.log("requestLocalSynchronization",e);var t=e.data.documents.posts||[],n=t.map(function(e){return function(){var t=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],n=_q2["default"].defer();return delete e._links,db.find({selector:{type:{$eq:TYPE_POST},"original.name":{$eq:e.name}},limit:1}).then(function(o){console.log("POST find values",o),o.docs.length?!function(){console.log("POST found",e.name);var s=o.docs[0];s.original&&s.original.content!==e.content||s.published!==e.published?(console.log("POST changed",e.name),e._id=s._id,e._rev=s._rev,e.type=TYPE_POST,db.put(e).then(function(){e._rev=s._rev,t.push(e),n.resolve(t)})["catch"](function(e){n.reject(e)})):(console.log("POST changed",e.name),e._id=s._id,e._rev=s._rev,e.type=TYPE_POST,t.push(e),n.resolve(t))}():(console.log("POST not found",e.name),e._id=_nodeUuid2["default"].v4(),e.type=TYPE_POST,db.put(e).then(function(o){e._rev=o.rev,t.push(e),n.resolve(t)})["catch"](function(e){n.reject(e)}))}),n.promise}}),o=(n||[]).reduce(function(e,t){return e.then(t)},(0,_q2["default"])([])),s=t.map(function(e){return e.name});console.log("POST remotePostNames",s);var r=db.find({selector:{type:{$eq:TYPE_POST},"original.name":{$nin:s}}}).then(function(e){if(e.docs.length){var t=e.docs.map(function(e){return _lodash2["default"].pick(e,["_id","_rev","attributes","content","excerpt","html","name","path","title","type","url"])});return console.error("POUCHDB posts",t),db.bulkDocs(t)}return console.error("POUCHDB refreshLocalPosts no post found"),[]});return r.then(function(){return o}).then(function(t){var n=Object.assign({},{posts:t},e.data.documents),o=Object.assign({},e.data,{documents:n});return Object.assign({},e,{data:o})})}),e.on("receiveConfig",function(e){return console.info("PouchDb Plugin - receiveConfig"),console.log("receiveConfig",e),db=new _pouchdb2["default"]("hubpress-"+e.data.config.meta.username+"-"+e.data.config.meta.repositoryName),db.info().then(function(e){console.log("PouchDB infos",e)}),db.createIndex({index:{fields:["name","type"]}}).then(function(){return db.createIndex({index:{fields:["type"]}})}).then(function(){return db.createIndex({index:{fields:["original.name","type"]}})}).then(function(){return db.createIndex({index:{fields:["published","type"]}})}).then(function(){return db.createIndex({index:{fields:["original.name","published","type"]}})}).then(function(){return e})}),e.on("requestLocalPosts",function(e){return console.info("PouchDb Plugin - requestLocalPosts"),console.log("requestLocalPosts",e),db.find({selector:{name:{$gt:null},type:{$eq:TYPE_POST}},sort:[{name:"desc"}]}).then(function(t){var n=Object.assign({},e.data,{posts:t.docs});return Object.assign({},e,{data:n})})}),e.on("requestSelectedPost",function(e){return console.info("PouchDb Plugin - requestSelectedPost"),console.log("requestSelectedPost",e),db.get(e.data.post._id).then(function(t){var n=Object.assign({},e.data,{selectedPost:t});return Object.assign({},e,{data:n})})}),e.on("requestLocalPost",function(e){console.info("PouchDb Plugin - requestLocalPost"),console.log("requestLocalPost",e);var t=_q2["default"].defer();return db.get(e.data.post._id).then(function(n){var o=Object.assign({},e.data,{post:n});t.resolve(Object.assign({},e,{data:o}))})["catch"](function(n){if(404===n.status){var o=Object.assign({},e.data,{post:{_id:e.data.post._id}});t.resolve(Object.assign({},e,{data:o}))}else t.reject(n)}),t.promise}),e.on("requestSaveLocalPost",function(e){console.info("PouchDb Plugin - requestSaveLocalPost"),console.log("requestSaveLocalPost",e);var t=_q2["default"].defer();return db.find({selector:{_id:{$ne:e.data.post._id},name:{$eq:e.data.post.name},type:{$eq:TYPE_POST}},limit:1}).then(function(t){if(t.docs.length)throw new Error("Post with the name "+e.data.post.name+" already exist");return e.data.post._id}).then(function(e){return db.get(e)}).then(function(n){var o=Object.assign({},n,e.data.post);o._rev=n._rev,o.type=TYPE_POST,db.put(o).then(function(n){o._rev=n.rev;var s=Object.assign({},e.data,{post:o});t.resolve(Object.assign({},e,{data:s}))})["catch"](function(e){return t.reject(e)})})["catch"](function(n){404===n.status?!function(){var n=Object.assign({},e.data.post);db.put(n).then(function(o){n._rev=o.rev;var s=Object.assign({},e.data,{post:n});t.resolve(Object.assign({},e,{data:s}))})["catch"](function(e){return t.reject(e)})}():t.reject(n)}),t.promise}),e.on("requestLocalPublishedPosts",function(e){return console.info("PouchDb Plugin - requestLocalPublishedPosts"),console.log("requestLocalPublishedPosts",e),db.find({selector:{"original.name":{$gt:null},published:{$eq:1},type:{$eq:TYPE_POST}},sort:[{"original.name":"desc"}]}).then(function(t){console.log("requestLocalPublishedPosts => ",t);var n=Object.assign({},e.data,{publishedPosts:t.docs});return Object.assign({},e,{data:n})})}),e.on("requestDeleteLocalPost",function(e){return console.info("PouchDb Plugin - requestDeleteLocalPost"),console.log("requestDeleteLocalPost",e),db.remove(e.data.post._id,e.data.post._rev).then(function(){return e})})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.pouchDbPlugin=pouchDbPlugin;var _q=require("q"),_q2=_interopRequireDefault(_q),_lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash),_nodeUuid=require("node-uuid"),_nodeUuid2=_interopRequireDefault(_nodeUuid),_pouchdb=require("pouchdb"),_pouchdb2=_interopRequireDefault(_pouchdb),_pouchdbFind=require("pouchdb-find"),_pouchdbFind2=_interopRequireDefault(_pouchdbFind);_pouchdb2["default"].plugin(_pouchdbFind2["default"]),window.PouchDB=_pouchdb2["default"];var TYPE_POST="post",db=void 0;